#!/bin/bash

# ๐ Smart Auto-Push to GitHub Script
# Usage: ./smart-push.sh [commit-message] [branch-name]
# Example: ./smart-push.sh "Fix user login bug" ment-v1.0.0

# Exit on error but allow specific error handling
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to show help
show_help() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐ Smart Push CLI - Help ๐        โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${MAGENTA}๐ Usage:${NC}"
    echo -e "  ${CYAN}smart-push [commit-message] [branch-name]${NC}"
    echo ""
    echo -e "${MAGENTA}๐ Examples:${NC}"
    echo -e "  ${CYAN}smart-push${NC}                                    # Interactive mode"
    echo -e "  ${CYAN}smart-push \"Fix user login bug\"${NC}              # With commit message"
    echo -e "  ${CYAN}smart-push \"Add new feature\" feature-branch${NC}   # With message and branch"
    echo ""
    echo -e "${MAGENTA}๐ง Options:${NC}"
    echo -e "  ${CYAN}-h, --help${NC}        Show this help message"
    echo -e "  ${CYAN}-v, --version${NC}     Show version information"
    echo -e "  ${CYAN}--update${NC}           Update to latest version"
    echo ""
    echo -e "${MAGENTA}๐ Smart Commands:${NC}"
    echo -e "  ${CYAN}--smart-pull${NC}       Smart pull with auto-stash"
    echo -e "  ${CYAN}--smart-commit${NC}     Smart commit with suggestions"
    echo -e "  ${CYAN}--smart-push${NC}       Smart push to current branch"
    echo -e "  ${CYAN}--status${NC}           Show detailed repository status"
    echo -e "  ${CYAN}--sync${NC}             Sync repository (pull + push)"
    echo -e "  ${CYAN}--clean${NC}            Clean untracked files and reset"
    echo ""
    echo -e "${MAGENTA}โจ Features:${NC}"
    echo -e "  ${CYAN}โข${NC} Smart commit message suggestions"
    echo -e "  ${CYAN}โข${NC} Automatic project type detection"
    echo -e "  ${CYAN}โข${NC} Pre-commit checks for common issues"
    echo -e "  ${CYAN}โข${NC} Interactive workflow with colored output"
    echo -e "  ${CYAN}โข${NC} Support for custom commit messages and branches"
    echo -e "  ${CYAN}โข${NC} Auto-stash before pull operations"
    echo -e "  ${CYAN}โข${NC} Smart branch detection and creation"
    echo -e "  ${CYAN}โข${NC} Repository status and cleanup tools"
    echo -e "  ${CYAN}โข${NC} Automatic sync and conflict resolution"
    echo ""
    echo -e "${MAGENTA}๐ Repository:${NC}"
    echo -e "  ${CYAN}https://github.com/techey-solution/smart-push${NC}"
    echo ""
    echo -e "${GREEN}Happy coding! ๐${NC}"
}

# Function to show version
show_version() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐ Smart Push CLI - Version ๐     โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${MAGENTA}๐ฆ Smart Push CLI v1.0.0${NC}"
    echo ""
    echo -e "${CYAN}Description:${NC} Smart Auto-Push to GitHub CLI tool"
    echo -e "${CYAN}Author:${NC}      Techey Solution"
    echo -e "${CYAN}License:${NC}     MIT"
    echo -e "${CYAN}Repository:${NC} https://github.com/techey-solution/smart-push"
    echo ""
    echo -e "${GREEN}Built with โค๏ธ for developers${NC}"
}

# Function to update smart-push
update_smart_push() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐ Smart Push CLI - Update ๐      โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    
    echo -e "${YELLOW}๐ Checking for updates...${NC}"
    
    # Get current version
    CURRENT_VERSION="1.0.0"
    
    # Check if curl or wget is available
    if command -v curl >/dev/null 2>&1; then
        DOWNLOAD_CMD="curl -s"
    elif command -v wget >/dev/null 2>&1; then
        DOWNLOAD_CMD="wget -qO-"
    else
        echo -e "${RED}โ Neither curl nor wget found. Cannot update.${NC}"
        echo -e "${YELLOW}Please install curl or wget first.${NC}"
        exit 1
    fi
    
    # Download latest version from GitHub
    echo -e "${CYAN}๐ฅ Downloading latest version...${NC}"
    
    # Create temporary file
    TEMP_FILE=$(mktemp)
    
    if $DOWNLOAD_CMD https://raw.githubusercontent.com/techey-solution/smart-push/main/smart-push > "$TEMP_FILE"; then
        echo -e "${GREEN}โ Downloaded successfully${NC}"
        
        # Check if download was successful (file should contain our script)
        if grep -q "Smart Auto-Push to GitHub" "$TEMP_FILE"; then
            echo -e "${CYAN}๐ Verifying downloaded file...${NC}"
            
            # Make it executable
            chmod +x "$TEMP_FILE"
            
            # Test the downloaded script
            if "$TEMP_FILE" --version >/dev/null 2>&1; then
                echo -e "${GREEN}โ Downloaded file is valid${NC}"
                
                # Find where smart-push is installed
                INSTALL_PATH=""
                if command -v smart-push >/dev/null 2>&1; then
                    INSTALL_PATH=$(which smart-push)
                else
                    # Try common locations
                    for path in /usr/local/bin/smart-push /usr/bin/smart-push ~/.local/bin/smart-push; do
                        if [ -f "$path" ]; then
                            INSTALL_PATH="$path"
                            break
                        fi
                    done
                fi
                
                if [ -n "$INSTALL_PATH" ]; then
                    echo -e "${CYAN}๐ Found installation at: ${INSTALL_PATH}${NC}"
                    
                    # Backup current version
                    cp "$INSTALL_PATH" "${INSTALL_PATH}.backup" 2>/dev/null || sudo cp "$INSTALL_PATH" "${INSTALL_PATH}.backup"
                    echo -e "${YELLOW}๐พ Backed up current version${NC}"
                    
                    # Install new version (try without sudo first, then with sudo)
                    if mv "$TEMP_FILE" "$INSTALL_PATH" 2>/dev/null || sudo mv "$TEMP_FILE" "$INSTALL_PATH"; then
                        echo -e "${GREEN}โ Updated successfully!${NC}"
                        echo ""
                        echo -e "${MAGENTA}๐ Update Summary:${NC}"
                        echo -e "  ${CYAN}Old Version:${NC} ${CURRENT_VERSION}"
                        echo -e "  ${CYAN}New Version:${NC} $(smart-push --version | grep "v[0-9]" | head -1 | sed 's/.*v\([0-9.]*\).*/\1/')"
                        echo -e "  ${CYAN}Location:${NC} ${INSTALL_PATH}"
                        echo ""
                        echo -e "${GREEN}๐ Smart Push CLI has been updated!${NC}"
                        echo -e "${YELLOW}Run 'smart-push --version' to verify the update.${NC}"
                    else
                        echo -e "${RED}โ Failed to install new version${NC}"
                        echo -e "${YELLOW}Restoring backup...${NC}"
                        mv "${INSTALL_PATH}.backup" "$INSTALL_PATH" 2>/dev/null || sudo mv "${INSTALL_PATH}.backup" "$INSTALL_PATH"
                        exit 1
                    fi
                else
                    echo -e "${RED}โ Could not find smart-push installation${NC}"
                    echo -e "${YELLOW}Please install smart-push first using the installer.${NC}"
                    rm -f "$TEMP_FILE"
                    exit 1
                fi
            else
                echo -e "${RED}โ Downloaded file is invalid${NC}"
                rm -f "$TEMP_FILE"
                exit 1
            fi
        else
            echo -e "${RED}โ Downloaded file is corrupted${NC}"
            rm -f "$TEMP_FILE"
            exit 1
        fi
    else
        echo -e "${RED}โ Failed to download latest version${NC}"
        echo -e "${YELLOW}Please check your internet connection and try again.${NC}"
        rm -f "$TEMP_FILE"
        exit 1
    fi
}

# Function for smart pull only
smart_pull() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐ Smart Pull - GitHub ๐         โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    
    # Get current branch
    CURRENT_BRANCH=$(git branch --show-current)
    echo -e "${CYAN}๐ฟ Current branch: ${CURRENT_BRANCH}${NC}"
    
    # Check for uncommitted changes
    if [[ ! -z $(git status -s) ]]; then
        echo -e "${YELLOW}โ๏ธ  You have uncommitted changes${NC}"
        git status -s | head -10
        echo ""
        read -p "Do you want to stash changes before pulling? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git stash push -m "Auto-stash before smart pull $(date)"
            echo -e "${GREEN}โ Changes stashed${NC}"
        fi
    fi
    
    # Pull with rebase
    echo -e "${YELLOW}๐ Pulling latest changes...${NC}"
    if git pull --rebase origin $CURRENT_BRANCH; then
        echo -e "${GREEN}โ Pull successful${NC}"
        
        # Restore stashed changes if any
        if git stash list | grep -q "Auto-stash before smart pull"; then
            echo -e "${CYAN}๐ Restoring stashed changes...${NC}"
            git stash pop
            echo -e "${GREEN}โ Stashed changes restored${NC}"
        fi
    else
        echo -e "${RED}โ Pull failed - there might be conflicts${NC}"
        echo -e "${YELLOW}Please resolve conflicts manually and try again${NC}"
        exit 1
    fi
}

# Function for smart commit only
smart_commit_only() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐ Smart Commit - GitHub ๐       โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    
    # Check for changes
    if [[ -z $(git status -s) ]]; then
        echo -e "${YELLOW}โ๏ธ  No changes to commit!${NC}"
        exit 0
    fi
    
    echo -e "${GREEN}โ Changes detected:${NC}"
    git status -s | head -20
    
    # Get commit message
    COMMIT_MESSAGE=${2:-""}
    if [ -z "$COMMIT_MESSAGE" ]; then
        echo -e "${CYAN}๐ก Smart commit message suggestions:${NC}"
        echo ""
        echo -e "  ${BLUE}1.${NC} Fix bug"
        echo -e "  ${BLUE}2.${NC} Add feature"
        echo -e "  ${BLUE}3.${NC} Update documentation"
        echo -e "  ${BLUE}4.${NC} Refactor code"
        echo -e "  ${BLUE}5.${NC} Custom message"
        echo ""
        read -p "Choose option (1-5): " choice
        
        case $choice in
            1) COMMIT_MESSAGE="Fix: $(git status -s | head -1 | awk '{print $2}' | xargs basename)" ;;
            2) COMMIT_MESSAGE="Feature: $(git status -s | head -1 | awk '{print $2}' | xargs basename)" ;;
            3) COMMIT_MESSAGE="Docs: Update documentation" ;;
            4) COMMIT_MESSAGE="Refactor: Improve code structure" ;;
            5) 
                read -p "Enter commit message: " COMMIT_MESSAGE
                ;;
            *) COMMIT_MESSAGE="Update $(date +%Y-%m-%d)" ;;
        esac
    fi
    
    # Stage and commit
    git add .
    if git commit -m "$COMMIT_MESSAGE"; then
        echo -e "${GREEN}โ Committed successfully: ${COMMIT_MESSAGE}${NC}"
    else
        echo -e "${RED}โ Commit failed${NC}"
        exit 1
    fi
}

# Function for smart push only
smart_push_only() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐ Smart Push - GitHub ๐         โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    
    CURRENT_BRANCH=$(git branch --show-current)
    echo -e "${CYAN}๐ฟ Pushing branch: ${CURRENT_BRANCH}${NC}"
    
    # Check if branch exists on remote
    if git ls-remote --heads origin $CURRENT_BRANCH | grep -q $CURRENT_BRANCH; then
        echo -e "${CYAN}Pushing to existing branch: origin/${CURRENT_BRANCH}${NC}"
    else
        echo -e "${CYAN}Creating new branch on remote: origin/${CURRENT_BRANCH}${NC}"
        read -p "This will create a new remote branch. Continue? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${BLUE}โ Push cancelled${NC}"
            exit 0
        fi
    fi
    
    # Push
    if git push origin $CURRENT_BRANCH; then
        echo -e "${GREEN}โ Pushed to GitHub successfully!${NC}"
        COMMIT_HASH=$(git rev-parse --short HEAD)
        echo -e "${CYAN}๐ Latest commit: ${COMMIT_HASH}${NC}"
    else
        echo -e "${RED}โ Push failed!${NC}"
        exit 1
    fi
}

# Function to show repository status
show_status() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐ Repository Status ๐           โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    
    # Current branch
    CURRENT_BRANCH=$(git branch --show-current)
    echo -e "${CYAN}๐ฟ Current Branch: ${CURRENT_BRANCH}${NC}"
    
    # Remote info
    REMOTE_URL=$(git config --get remote.origin.url 2>/dev/null || echo "No remote")
    echo -e "${CYAN}๐ Remote: ${REMOTE_URL}${NC}"
    
    # Status
    echo -e "${YELLOW}๐ Status:${NC}"
    git status --porcelain | while read line; do
        STATUS=$(echo $line | cut -c1-2)
        FILE=$(echo $line | cut -c4-)
        case $STATUS in
            "??") echo -e "  ${GREEN}+${NC} ${FILE} (new file)" ;;
            "A ") echo -e "  ${BLUE}+${NC} ${FILE} (added)" ;;
            "M ") echo -e "  ${YELLOW}~${NC} ${FILE} (modified)" ;;
            "D ") echo -e "  ${RED}-${NC} ${FILE} (deleted)" ;;
            " M") echo -e "  ${YELLOW}~${NC} ${FILE} (modified, staged)" ;;
            " D") echo -e "  ${RED}-${NC} ${FILE} (deleted, staged)" ;;
        esac
    done
    
    # Recent commits
    echo -e "${YELLOW}๐ Recent Commits:${NC}"
    git log --oneline -5 | while read line; do
        echo -e "  ${CYAN}โข${NC} ${line}"
    done
    
    # Branch info
    echo -e "${YELLOW}๐ฟ Branches:${NC}"
    git branch -v | while read line; do
        if [[ $line == *"*"* ]]; then
            echo -e "  ${GREEN}โ${NC} ${line}"
        else
            echo -e "  ${CYAN} ${NC} ${line}"
        fi
    done
}

# Function to sync repository
sync_repository() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐ Sync Repository ๐             โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    
    CURRENT_BRANCH=$(git branch --show-current)
    echo -e "${CYAN}๐ฟ Syncing branch: ${CURRENT_BRANCH}${NC}"
    
    # Fetch latest
    echo -e "${YELLOW}๐ฅ Fetching latest changes...${NC}"
    git fetch origin
    
    # Check if we're behind
    BEHIND=$(git rev-list --count HEAD..origin/$CURRENT_BRANCH 2>/dev/null || echo "0")
    AHEAD=$(git rev-list --count origin/$CURRENT_BRANCH..HEAD 2>/dev/null || echo "0")
    
    if [ "$BEHIND" -gt 0 ]; then
        echo -e "${YELLOW}โ๏ธ  You are ${BEHIND} commits behind${NC}"
        smart_pull
    fi
    
    if [ "$AHEAD" -gt 0 ]; then
        echo -e "${YELLOW}โ๏ธ  You are ${AHEAD} commits ahead${NC}"
        smart_push_only
    fi
    
    if [ "$BEHIND" -eq 0 ] && [ "$AHEAD" -eq 0 ]; then
        echo -e "${GREEN}โ Repository is up to date!${NC}"
    fi
}

# Function to clean repository
clean_repository() {
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ   ๐งน Clean Repository ๐            โ${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    
    echo -e "${YELLOW}๐งน Cleaning repository...${NC}"
    
    # Clean untracked files
    UNTRACKED=$(git clean -n | wc -l)
    if [ "$UNTRACKED" -gt 0 ]; then
        echo -e "${CYAN}Found ${UNTRACKED} untracked files${NC}"
        read -p "Remove untracked files? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git clean -f
            echo -e "${GREEN}โ Untracked files removed${NC}"
        fi
    fi
    
    # Clean untracked directories
    UNTRACKED_DIRS=$(git clean -nd | grep "Would remove" | wc -l)
    if [ "$UNTRACKED_DIRS" -gt 0 ]; then
        echo -e "${CYAN}Found ${UNTRACKED_DIRS} untracked directories${NC}"
        read -p "Remove untracked directories? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git clean -fd
            echo -e "${GREEN}โ Untracked directories removed${NC}"
        fi
    fi
    
    # Reset to clean state
    if [[ ! -z $(git status -s) ]]; then
        echo -e "${YELLOW}โ๏ธ  You have uncommitted changes${NC}"
        read -p "Reset all changes? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git reset --hard HEAD
            echo -e "${GREEN}โ All changes reset${NC}"
        fi
    fi
    
    echo -e "${GREEN}โ Repository cleaned!${NC}"
}

# Check for help flags FIRST (before any other processing)
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]] || [[ "$1" == "help" ]]; then
    show_help
    exit 0
fi

# Check for version flag
if [[ "$1" == "-v" ]] || [[ "$1" == "--version" ]] || [[ "$1" == "version" ]]; then
    show_version
    exit 0
fi

# Check for update flag
if [[ "$1" == "--update" ]] || [[ "$1" == "update" ]]; then
    update_smart_push
    exit 0
fi

# Check for smart flags
if [[ "$1" == "--smart-pull" ]] || [[ "$1" == "smart-pull" ]]; then
    smart_pull
    exit 0
fi

if [[ "$1" == "--smart-commit" ]] || [[ "$1" == "smart-commit" ]]; then
    smart_commit_only
    exit 0
fi

if [[ "$1" == "--smart-push" ]] || [[ "$1" == "smart-push" ]]; then
    smart_push_only
    exit 0
fi

if [[ "$1" == "--status" ]] || [[ "$1" == "status" ]]; then
    show_status
    exit 0
fi

if [[ "$1" == "--sync" ]] || [[ "$1" == "sync" ]]; then
    sync_repository
    exit 0
fi

if [[ "$1" == "--clean" ]] || [[ "$1" == "clean" ]]; then
    clean_repository
    exit 0
fi

# Banner
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}โ   ๐ Smart Auto-Push to GitHub ๐    โ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# Get parameters
COMMIT_MESSAGE=${1}
TARGET_BRANCH=${2}

# Get current branch if not specified
if [ -z "$TARGET_BRANCH" ]; then
    TARGET_BRANCH=$(git branch --show-current)
    echo -e "${CYAN}โน๏ธ  Using current branch: ${TARGET_BRANCH}${NC}"
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}โ Error: Not a git repository!${NC}"
    echo -e "${YELLOW}Please run this script from within your project directory.${NC}"
    exit 1
fi

# Get project type (backend/frontend)
if [ -f "composer.json" ]; then
    PROJECT_TYPE="backend"
    PROJECT_NAME="API"
elif [ -f "package.json" ]; then
    PROJECT_TYPE="frontend"
    PROJECT_NAME="Frontend"
else
    PROJECT_TYPE="unknown"
    PROJECT_NAME="Project"
fi

echo -e "${MAGENTA}๐ฆ Project Type: ${PROJECT_NAME}${NC}"
echo -e "${CYAN}๐ฟ Target Branch: ${TARGET_BRANCH}${NC}"
echo ""

# Step 1: Check for uncommitted changes
echo -e "${YELLOW}Step 1: Checking for changes...${NC}"
if [[ -z $(git status -s) ]]; then
    echo -e "${YELLOW}โ๏ธ  No changes to commit!${NC}"
    read -p "Do you want to push anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}โ Push cancelled.${NC}"
        exit 0
    fi
else
    echo -e "${GREEN}โ Changes detected:${NC}"
    git status -s | head -20
    if [ $(git status -s | wc -l) -gt 20 ]; then
        echo -e "${YELLOW}... and $(($(git status -s | wc -l) - 20)) more files${NC}"
    fi
fi
echo ""

# Step 2: Get commit message if not provided
if [ -z "$COMMIT_MESSAGE" ]; then
    echo -e "${YELLOW}Step 2: Creating commit message...${NC}"
    echo -e "${CYAN}๐ก Smart suggestions based on changes:${NC}"
    
    # Analyze changes and suggest commit messages
    CHANGED_FILES=$(git status -s | awk '{print $2}')
    
    # Count file types
    PHP_COUNT=$(echo "$CHANGED_FILES" | grep -c '\.php$' || true)
    VUE_COUNT=$(echo "$CHANGED_FILES" | grep -c '\.vue$' || true)
    JS_COUNT=$(echo "$CHANGED_FILES" | grep -c '\.js$' || true)
    CSS_COUNT=$(echo "$CHANGED_FILES" | grep -c '\.css$' || true)
    CONFIG_COUNT=$(echo "$CHANGED_FILES" | grep -c 'config\|\.env\|\.yml\|\.json$' || true)
    
    # Suggest commit messages
    echo ""
    if [ $PHP_COUNT -gt 0 ]; then
        echo -e "  ${BLUE}1.${NC} Update backend logic ($PHP_COUNT PHP files)"
    fi
    if [ $VUE_COUNT -gt 0 ]; then
        echo -e "  ${BLUE}2.${NC} Update frontend components ($VUE_COUNT Vue files)"
    fi
    if [ $JS_COUNT -gt 0 ]; then
        echo -e "  ${BLUE}3.${NC} Update JavaScript logic ($JS_COUNT JS files)"
    fi
    if [ $CONFIG_COUNT -gt 0 ]; then
        echo -e "  ${BLUE}4.${NC} Update configuration files ($CONFIG_COUNT files)"
    fi
    echo -e "  ${BLUE}5.${NC} Bug fix"
    echo -e "  ${BLUE}6.${NC} Feature implementation"
    echo -e "  ${BLUE}7.${NC} Code refactoring"
    echo -e "  ${BLUE}8.${NC} Documentation update"
    echo -e "  ${BLUE}9.${NC} Custom message"
    echo ""
    
    read -p "Choose an option (1-9) or press Enter for custom: " choice
    echo ""
    
    case $choice in
        1) COMMIT_MESSAGE="Update backend logic" ;;
        2) COMMIT_MESSAGE="Update frontend components" ;;
        3) COMMIT_MESSAGE="Update JavaScript logic" ;;
        4) COMMIT_MESSAGE="Update configuration" ;;
        5) 
            read -p "Describe the bug fix: " bug_desc
            COMMIT_MESSAGE="Fix: $bug_desc"
            ;;
        6)
            read -p "Describe the feature: " feature_desc
            COMMIT_MESSAGE="Feature: $feature_desc"
            ;;
        7) COMMIT_MESSAGE="Refactor: Improve code structure" ;;
        8) COMMIT_MESSAGE="Docs: Update documentation" ;;
        9|*)
            read -p "Enter commit message: " COMMIT_MESSAGE
            ;;
    esac
    
    # If still empty, use default
    if [ -z "$COMMIT_MESSAGE" ]; then
        COMMIT_MESSAGE="Update $(date +%Y-%m-%d)"
    fi
fi

echo -e "${GREEN}๐ Commit message: ${COMMIT_MESSAGE}${NC}"
echo ""

# Step 3: Pre-commit checks
echo -e "${YELLOW}Step 3: Running pre-commit checks...${NC}"

# Check for common issues
ERROR_COUNT=0

# Check for debugging statements
echo -e "${CYAN}Checking for debug statements...${NC}"
if git diff --cached --name-only | xargs grep -n "console.log\|var_dump\|dd(\|dump(" 2>/dev/null; then
    echo -e "${YELLOW}โ๏ธ  Found debugging statements (this is OK for dev)${NC}"
fi

# Check for TODO/FIXME
echo -e "${CYAN}Checking for TODO/FIXME...${NC}"
TODO_COUNT=$(git diff --cached | grep -c "TODO\|FIXME" || true)
if [ $TODO_COUNT -gt 0 ]; then
    echo -e "${YELLOW}โน๏ธ  Found $TODO_COUNT TODO/FIXME comments${NC}"
fi

# Check for merge conflict markers
echo -e "${CYAN}Checking for merge conflict markers...${NC}"
if git diff --cached | grep -q "^<<<<<<\|^>>>>>>\|^======"; then
    echo -e "${RED}โ Found merge conflict markers!${NC}"
    echo -e "${RED}Please resolve conflicts before pushing.${NC}"
    ERROR_COUNT=$((ERROR_COUNT + 1))
fi

# Check for large files (>5MB)
echo -e "${CYAN}Checking for large files...${NC}"
LARGE_FILES=$(git diff --cached --name-only | xargs ls -lh 2>/dev/null | awk '$5 ~ /M$/ && $5+0 > 5 {print $9, $5}' || true)
if [ ! -z "$LARGE_FILES" ]; then
    echo -e "${YELLOW}โ๏ธ  Large files detected:${NC}"
    echo "$LARGE_FILES"
    read -p "Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}โ Push cancelled.${NC}"
        exit 0
    fi
fi

if [ $ERROR_COUNT -gt 0 ]; then
    echo -e "${RED}โ Found $ERROR_COUNT critical errors. Please fix them first.${NC}"
    exit 1
fi

echo -e "${GREEN}โ Pre-commit checks passed${NC}"
echo ""

# Step 4: Stage and commit
echo -e "${YELLOW}Step 4: Staging and committing changes...${NC}"

# Add all changes
git add .
echo -e "${GREEN}โ Staged all changes${NC}"

# Commit
if git commit -m "$COMMIT_MESSAGE"; then
    echo -e "${GREEN}โ Committed successfully${NC}"
else
    if [ $? -eq 1 ]; then
        echo -e "${YELLOW}โน๏ธ  Nothing to commit (working tree clean)${NC}"
    else
        echo -e "${RED}โ Commit failed${NC}"
        exit 1
    fi
fi
echo ""

# Step 5: Pull latest changes (to avoid conflicts)
echo -e "${YELLOW}Step 5: Pulling latest changes from remote...${NC}"
if git pull origin $TARGET_BRANCH --no-rebase 2>&1 | tee /tmp/git_pull_output.txt; then
    if grep -q "Already up to date" /tmp/git_pull_output.txt; then
        echo -e "${GREEN}โ Already up to date${NC}"
    else
        echo -e "${GREEN}โ Pulled latest changes${NC}"
    fi
else
    if grep -q "CONFLICT" /tmp/git_pull_output.txt; then
        echo -e "${RED}โ Merge conflicts detected!${NC}"
        echo -e "${YELLOW}Please resolve conflicts manually and try again.${NC}"
        rm -f /tmp/git_pull_output.txt
        exit 1
    fi
fi
rm -f /tmp/git_pull_output.txt
echo ""

# Step 6: Push to remote
echo -e "${YELLOW}Step 6: Pushing to GitHub...${NC}"

# Check if branch exists on remote
if git ls-remote --heads origin $TARGET_BRANCH | grep -q $TARGET_BRANCH; then
    echo -e "${CYAN}Pushing to existing branch: origin/${TARGET_BRANCH}${NC}"
else
    echo -e "${CYAN}Creating new branch on remote: origin/${TARGET_BRANCH}${NC}"
    read -p "This will create a new remote branch. Continue? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}โ Push cancelled.${NC}"
        exit 0
    fi
fi

# Push
if git push origin $TARGET_BRANCH; then
    echo -e "${GREEN}โ Pushed to GitHub successfully!${NC}"
else
    echo -e "${RED}โ Push failed!${NC}"
    echo -e "${YELLOW}Try running: git push origin ${TARGET_BRANCH} --force${NC}"
    echo -e "${RED}โ๏ธ  Warning: Force push will overwrite remote changes!${NC}"
    exit 1
fi
echo ""

# Step 7: Summary
COMMIT_HASH=$(git rev-parse --short HEAD)
REMOTE_URL=$(git config --get remote.origin.url)

echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ        โ Push Successful! โ          โ${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo -e "${MAGENTA}๐ Summary:${NC}"
echo -e "  ${CYAN}Project:${NC}      ${PROJECT_NAME}"
echo -e "  ${CYAN}Branch:${NC}       ${TARGET_BRANCH}"
echo -e "  ${CYAN}Commit:${NC}       ${COMMIT_HASH}"
echo -e "  ${CYAN}Message:${NC}      ${COMMIT_MESSAGE}"
echo -e "  ${CYAN}Remote:${NC}       ${REMOTE_URL}"
echo ""
echo -e "${YELLOW}๐ Quick Links:${NC}"
echo -e "  ${CYAN}View on GitHub:${NC} $(echo $REMOTE_URL | sed 's/\.git$//' | sed 's/git@github.com:/https:\/\/github.com\//')"
echo -e "  ${CYAN}Commits:${NC}        $(echo $REMOTE_URL | sed 's/\.git$//' | sed 's/git@github.com:/https:\/\/github.com\//').git/commits/${TARGET_BRANCH}"
echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}Happy Coding! Enjoy your day! Happy Life! Happy Programming! Happy Success! ${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
